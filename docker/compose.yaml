services:
  mt5:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        # Pin versions for reproducibility (update in versions.env)
        PYTHON_VERSION: "3.12"
        GRPCIO_VERSION: "1.76.0"
        WINE_MONO_VERSION: "9.4.0"
        NUMPY_VERSION: "1.26.4"
        # MT5 pip package installed at runtime (always latest)
        BUILD_DATE: "${BUILD_DATE:-}"
        VERSION: "${VERSION:-local}"
    image: marlonsc/mt5-docker:local
    container_name: ${MT5_CONTAINER_NAME:-mt5}
    volumes:
      # Volume key is 'config_data', actual name is set by MT5_VOLUME_NAME in volumes section
      - config_data:/config:uid=911,gid=911
    ports:
      - "${MT5_VNC_PORT:-3000}:3000"      # KasmVNC web interface
      - "${MT5_GRPC_PORT:-50051}:50051"   # gRPC server for mt5linux
      - "${MT5_HEALTH_PORT:-8002}:8002"   # Health check endpoint
    env_file:
      - path: ../.env
        required: true
    labels:
      org.opencontainers.image.title: "MetaTrader5 Docker (fork)"
      org.opencontainers.image.vendor: "marlonsc"
      org.opencontainers.image.source: "https://github.com/marlonsc/mt5-docker"
    environment:
      # Core settings
      - ENABLE_WIN_DOTNET=1       # Enable .NET Framework for EAs
      - TZ=UTC                    # Container timezone
      # Staging configuration
      - STAGING_DIR=/opt/mt5-staging
      # MT5 Auto-login credentials loaded via env_file (../.env)
      # Health monitoring and auto-recovery
      - HEALTH_CHECK_INTERVAL=${HEALTH_CHECK_INTERVAL:-30}
      - AUTO_RECOVERY_ENABLED=${AUTO_RECOVERY_ENABLED:-1}
      # Debug and update settings
      - MT5_DEBUG=${MT5_DEBUG:-1}     # Enable debug logging in gRPC bridge (1=on, 0=off)
      - MT5_UPDATE=${MT5_UPDATE:-1}   # Update components on startup (1=on, 0=off)
    restart: unless-stopped
    # Resource limits for production
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.5'
          memory: 2.5G
    # Logging configuration
    logging:
      driver: json-file
      options:
        max-size: "100m"
        max-file: "5"
    # File descriptor limits for Wine/MT5
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
      nproc:
        soft: 4096
        hard: 4096
    # Required for EAs to work properly (MetaQuotes protection)
    cap_add:
      - SYS_PTRACE
    security_opt:
      - seccomp:unconfined
    healthcheck:
      # Check gRPC server (primary API) - port 50051
      test: ["CMD", "bash", "-c", "echo >/dev/tcp/localhost/50051"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    networks:
      - mt5-network

networks:
  mt5-network:
    driver: bridge
    name: ${MT5_NETWORK_NAME:-mt5-network}
    labels:
      description: "Isolated network for MT5 container"

volumes:
  config_data:
    name: ${MT5_VOLUME_NAME:-config_data}
    driver: local
    labels:
      description: "MT5 data: Wine prefix, terminal settings, EAs, indicators, history"
