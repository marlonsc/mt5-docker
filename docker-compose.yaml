services:
  mt5:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        # Pin versions for reproducibility (update in versions.env)
        PYTHON_VERSION: "3.12.8"
        GECKO_VERSION: "2.47.4"
        MT5_PYPI_VERSION: "5.0.5430"
        BUILD_DATE: "${BUILD_DATE:-}"
        VERSION: "${VERSION:-local}"
    image: glendekoning/mt5-docker:local
    container_name: ${MT5_CONTAINER_NAME:-mt5}
    volumes:
      - config_data:/config:uid=911,gid=911
      - downloads:/downloads:uid=911,gid=911
      # External cache volume - survives docker system prune
      - mt5_cache:/cache:uid=911,gid=911
      # Mount data directory for EA files and settings
      - ./data:/data:ro
    ports:
      - "${MT5_VNC_PORT:-3000}:3000"    # KasmVNC web interface
      - "${MT5_RPYC_PORT:-8001}:8001"   # RPyC server for mt5linux
      - "${MT5_HEALTH_PORT:-8002}:8002" # Health check endpoint
    env_file:
      - .env
    labels:
      org.opencontainers.image.title: "MetaTrader5 Docker (fork)"
      org.opencontainers.image.vendor: "glendekoning"
      org.opencontainers.image.source: "https://github.com/glendekoning/mt5-docker"
    environment:
      # Core settings
      - ENABLE_WIN_DOTNET=1       # Enable .NET Framework for EAs
      - TZ=UTC                    # Container timezone
      # Cache configuration
      - STAGING_DIR=/opt/mt5-staging
      - CACHE_DIR=/cache
      # MT5 Auto-login credentials (from .env file)
      - MT5_LOGIN=${MT5_LOGIN:-}
      - MT5_PASSWORD=${MT5_PASSWORD:-}
      - MT5_SERVER=${MT5_SERVER:-}
      # Health monitoring and auto-recovery
      - HEALTH_CHECK_INTERVAL=${HEALTH_CHECK_INTERVAL:-30}
      - AUTO_RECOVERY_ENABLED=${AUTO_RECOVERY_ENABLED:-1}
    restart: unless-stopped
    # Resource limits for production
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.5'
          memory: 2.5G
    # Logging configuration
    logging:
      driver: json-file
      options:
        max-size: "100m"
        max-file: "5"
    # File descriptor limits for Wine/MT5
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
      nproc:
        soft: 4096
        hard: 4096
    # Required for EAs to work properly (MetaQuotes protection)
    cap_add:
      - SYS_PTRACE
    security_opt:
      - seccomp:unconfined
    healthcheck:
      # Check mt5linux RPyC server (primary API) - port 8001
      test: ["CMD", "bash", "-c", "echo >/dev/tcp/localhost/8001"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    networks:
      - mt5-network

networks:
  mt5-network:
    driver: bridge
    name: mt5-network
    labels:
      description: "Isolated network for MT5 container"

volumes:
  config_data:
    driver: local
    labels:
      description: "MT5 configuration and Wine prefix"

  downloads:
    driver: local
    labels:
      description: "Persistent downloads for debugging"

  # Cache volume with explicit name - survives docker system prune
  # Only removed with: docker volume rm mt5_cache
  # Or: docker system prune --volumes
  mt5_cache:
    driver: local
    name: mt5_cache
    labels:
      description: "Persistent cache for MT5 installers (survives prune)"
      prune.protect: "true"
      managed.by: "mt5docker"

# Build with: DOCKER_BUILDKIT=1 docker compose build
# Or set in daemon.json: { "features": { "buildkit": true } }
#
# Usage notes:
# - Volume 'config_data' stores MT5 configuration and Wine environment
# - Volume 'downloads' persists all installer and download files for debugging
# - Volume 'mt5_cache' survives docker system prune (explicit name)
# - Use .env file to set CUSTOM_USER and PASSWORD for web interface
# by <marlonsc@gmail.com>
