services:
  mt5:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        # Pin versions for reproducibility (update in versions.env)
        PYTHON_VERSION: "3.12.8"
        GECKO_VERSION: "2.47.4"
        MT5_PYPI_VERSION: "5.0.5430"
        BUILD_DATE: "${BUILD_DATE:-}"
        VERSION: "${VERSION:-local}"
    image: glendekoning/mt5-docker:local
    container_name: mt5
    volumes:
      - config_data:/config:uid=911,gid=911
      - downloads:/downloads:uid=911,gid=911
      # External cache volume - survives docker system prune
      - mt5_cache:/cache:uid=911,gid=911
      # Mount data directory for EA files and settings
      - ./data:/data:ro
    ports:
      - 3000:3000  # KasmVNC web interface
      - 8001:8001  # RPyC server for mt5linux
      - 8002:8002  # Health check endpoint
    env_file:
      - .env
    labels:
      org.opencontainers.image.title: "MetaTrader5 Docker (fork)"
      org.opencontainers.image.vendor: "glendekoning"
      org.opencontainers.image.source: "https://github.com/glendekoning/mt5-docker"
    environment:
      # Core settings
      - ENABLE_WIN_DOTNET=1       # Enable .NET Framework for EAs
      - ENABLE_DATA_SYNC=1        # Enable EA/.set file synchronization
      - TZ=UTC                    # Container timezone
      # Cache configuration
      - STAGING_DIR=/opt/mt5-staging
      - CACHE_DIR=/cache
      # MT5 Auto-login credentials (from .env file)
      - MT5_LOGIN=${MT5_LOGIN:-}
      - MT5_PASSWORD=${MT5_PASSWORD:-}
      - MT5_SERVER=${MT5_SERVER:-}
      # Health monitoring and auto-recovery
      - HEALTH_CHECK_INTERVAL=${HEALTH_CHECK_INTERVAL:-30}
      - AUTO_RECOVERY_ENABLED=${AUTO_RECOVERY_ENABLED:-1}
      # RPyC resilient server settings
      - RPYC_RESILIENT=${RPYC_RESILIENT:-1}
      - RPYC_HEALTH_PORT=${RPYC_HEALTH_PORT:-8002}
      - RPYC_MAX_RESTARTS=${RPYC_MAX_RESTARTS:-10}
      - RPYC_MAX_CONNECTIONS=${RPYC_MAX_CONNECTIONS:-10}
    restart: unless-stopped
    # Required for EAs to work properly (MetaQuotes protection)
    cap_add:
      - SYS_PTRACE
    security_opt:
      - seccomp:unconfined
    healthcheck:
      # Check mt5linux RPyC server (primary API) - port 8001
      test: ["CMD", "bash", "-c", "echo >/dev/tcp/localhost/8001"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

volumes:
  config_data:
    driver: local
    labels:
      description: "MT5 configuration and Wine prefix"

  downloads:
    driver: local
    labels:
      description: "Persistent downloads for debugging"

  # Cache volume with explicit name - survives docker system prune
  # Only removed with: docker volume rm mt5_cache
  # Or: docker system prune --volumes
  mt5_cache:
    driver: local
    name: mt5_cache
    labels:
      description: "Persistent cache for MT5 installers (survives prune)"
      prune.protect: "true"
      managed.by: "mt5docker"

# Build with: DOCKER_BUILDKIT=1 docker compose build
# Or set in daemon.json: { "features": { "buildkit": true } }
#
# Usage notes:
# - Volume 'config_data' stores MT5 configuration and Wine environment
# - Volume 'downloads' persists all installer and download files for debugging
# - Volume 'mt5_cache' survives docker system prune (explicit name)
# - Use .env file to set CUSTOM_USER and PASSWORD for web interface
# by <marlonsc@gmail.com>
