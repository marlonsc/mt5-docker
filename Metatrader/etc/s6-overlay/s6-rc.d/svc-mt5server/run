#!/usr/bin/with-contenv bash
# s6 service: Wine RPyC server for MT5
#
# This service runs the RPyC server inside Wine, supervised by s6-overlay.
# If the process crashes, s6 will automatically restart it.
# Uses modern MT5Service (NOT deprecated ClassicService/SlaveService).

# Load environment from 00_env.sh (fail-fast if missing or broken)
ENV_FILE="/Metatrader/scripts/00_env.sh"
if [ ! -f "$ENV_FILE" ]; then
    echo "[svc-mt5server] ERROR: Environment file not found: $ENV_FILE"
    exit 1
fi
if ! source "$ENV_FILE"; then
    echo "[svc-mt5server] ERROR: Failed to load environment from $ENV_FILE"
    exit 1
fi

# Verify required variables are set
if [ -z "${wine_executable:-}" ]; then
    echo "[svc-mt5server] ERROR: wine_executable not defined"
    exit 1
fi
if [ -z "${mt5server_port:-}" ]; then
    echo "[svc-mt5server] ERROR: mt5server_port not defined"
    exit 1
fi
if [ -z "${WINE_PYTHON_PATH:-}" ]; then
    echo "[svc-mt5server] ERROR: WINE_PYTHON_PATH not defined"
    exit 1
fi

# Check if Wine prefix was built during Docker build (fast path)
BUILD_MARKER="${WINEPREFIX:-/config/.wine}/.build-complete"

# Startup markers in /tmp/ - container-local, always exists, not persistent
STARTUP_MARKER="/tmp/.mt5-startup-complete"
STARTUP_IN_PROGRESS="/tmp/.mt5-startup-in-progress"

# ============================================================
# Helper: Run command as user abc (owner of Wine prefix)
# ============================================================
run_as_abc() {
    s6-setuidgid abc "$@"
}

# ============================================================
# Helper: Check if Wine Python is working (run as abc)
# ============================================================
check_wine_python() {
    if [ ! -f "$WINE_PYTHON_PATH" ]; then
        echo "[svc-mt5server] Wine Python not found at: $WINE_PYTHON_PATH"
        return 1
    fi
    if ! run_as_abc ${wine_executable} "$WINE_PYTHON_PATH" --version 2>/dev/null; then
        echo "[svc-mt5server] Wine Python not executing properly"
        return 1
    fi
    return 0
}

# ============================================================
# Helper: Check if MetaTrader5 pip package is installed (run as abc)
# ============================================================
check_mt5_pip() {
    if ! run_as_abc ${wine_executable} "$WINE_PYTHON_PATH" -c "import MetaTrader5" 2>/dev/null; then
        echo "[svc-mt5server] MetaTrader5 pip package not installed"
        return 1
    fi
    return 0
}

# ============================================================
# Helper: Check if MT5 terminal is installed
# ============================================================
check_mt5_terminal() {
    if [ ! -f "$mt5file" ]; then
        echo "[svc-mt5server] MT5 terminal not found at: $mt5file"
        return 1
    fi
    return 0
}

# ============================================================
# Helper: Check if MT5 terminal is running
# ============================================================
is_mt5_running() {
    pgrep -f "terminal64.exe" >/dev/null 2>&1
}

# ============================================================
# Helper: Start MT5 terminal if not running (run as abc)
# Uses /config for auto-login (more reliable than /login per MQL5 forum research)
# See: https://www.mql5.com/en/forum/265448
# ============================================================
start_mt5_terminal() {
    if is_mt5_running; then
        echo "[svc-mt5server] MT5 terminal already running"
        return 0
    fi

    if ! check_mt5_terminal; then
        echo "[svc-mt5server] Cannot start MT5 - not installed"
        return 1
    fi

    echo "[svc-mt5server] Starting MT5 terminal..."

    # Check for config file generated by 30_mt5.sh
    MT5_CONFIG_PATH="$WINEPREFIX/drive_c/Program Files/MetaTrader 5/Config/startup.ini"

    if [ -f "$MT5_CONFIG_PATH" ]; then
        echo "[svc-mt5server] Using config file for auto-login: $MT5_CONFIG_PATH"
        # Windows path - note: MT5 handles the path internally, no extra quotes needed
        run_as_abc ${wine_executable} "$mt5file" /portable '/config:C:\Program Files\MetaTrader 5\Config\startup.ini' &
    else
        echo "[svc-mt5server] No config file found - starting without auto-login"
        run_as_abc ${wine_executable} "$mt5file" /portable &
    fi

    # Wait for terminal to start (max 30s)
    local waited=0
    while [ $waited -lt 30 ]; do
        if is_mt5_running; then
            echo "[svc-mt5server] MT5 terminal started"
            return 0
        fi
        sleep 2
        waited=$((waited + 2))
    done

    echo "[svc-mt5server] WARN: MT5 terminal may not have started"
    return 0  # Don't fail - let RPyC server try anyway
}

# ============================================================
# Wait for DISPLAY to be ready (Wine needs X11)
# ============================================================
echo "[svc-mt5server] Waiting for DISPLAY..."
MAX_DISPLAY_WAIT=60
DISPLAY_WAITED=0
while [ -z "${DISPLAY:-}" ] && [ $DISPLAY_WAITED -lt $MAX_DISPLAY_WAIT ]; do
    sleep 2
    DISPLAY_WAITED=$((DISPLAY_WAITED + 2))
    # Try to get DISPLAY from environment
    if [ -f /tmp/.X0-lock ] || [ -S /tmp/.X11-unix/X0 ]; then
        export DISPLAY=:0
        break
    fi
done

if [ -z "${DISPLAY:-}" ]; then
    # Default to :0 if not set
    export DISPLAY=:0
fi
echo "[svc-mt5server] DISPLAY=$DISPLAY"

# ============================================================
# Wait for startup scripts to complete
# The startup scripts properly initialize Wine prefix and install MT5
# Must wait for:
#   1. No STARTUP_IN_PROGRESS marker (startup is not running)
#   2. STARTUP_MARKER exists (startup completed successfully)
# This prevents race condition with stale markers from previous runs
# ============================================================
MAX_WAIT=600
WAITED=0
echo "[svc-mt5server] Waiting for startup scripts to complete..."
while [ $WAITED -lt $MAX_WAIT ]; do
    # Check both conditions: startup NOT in progress AND startup completed
    if [ ! -f "$STARTUP_IN_PROGRESS" ] && [ -f "$STARTUP_MARKER" ]; then
        break
    fi
    sleep 5
    WAITED=$((WAITED + 5))
    if [ $((WAITED % 30)) -eq 0 ]; then
        if [ -f "$STARTUP_IN_PROGRESS" ]; then
            echo "[svc-mt5server] Still waiting for startup to finish... (${WAITED}s/${MAX_WAIT}s)"
        else
            echo "[svc-mt5server] Waiting for startup marker... (${WAITED}s/${MAX_WAIT}s)"
        fi
    fi
done

if [ -f "$STARTUP_IN_PROGRESS" ] || [ ! -f "$STARTUP_MARKER" ]; then
    echo "[svc-mt5server] ERROR: Startup did not complete within ${MAX_WAIT}s"
    exit 1
fi
echo "[svc-mt5server] Startup complete"

# ============================================================
# Verify components before starting server
# ============================================================
echo "[svc-mt5server] Verifying components..."

# Check Wine Python
if ! check_wine_python; then
    echo "[svc-mt5server] ERROR: Wine Python not working"
    exit 1
fi
echo "[svc-mt5server] Wine Python OK"

# Check MetaTrader5 pip (installed by 30_mt5.sh during startup)
if ! check_mt5_pip; then
    echo "[svc-mt5server] ERROR: MetaTrader5 pip not installed - startup scripts may have failed"
    exit 1
fi
echo "[svc-mt5server] MetaTrader5 pip OK"

# Check and start MT5 terminal
if check_mt5_terminal; then
    start_mt5_terminal
else
    echo "[svc-mt5server] WARN: MT5 terminal not installed - RPyC will start but MT5 functions won't work"
fi

echo "[svc-mt5server] All checks passed, starting RPyC server..."

# Ensure server directory exists
mkdir -p /tmp/mt5linux

# Ensure all required directories have correct ownership (run as root before switching to abc user)
echo "[svc-mt5server] Ensuring directory permissions..."
if [ -d "/config" ]; then
    chown -R abc:abc "/config" 2>/dev/null || echo "[svc-mt5server] Warning: Failed to chown /config"
fi
echo "[svc-mt5server] Directory permissions set"

# Generate the RPyC server script with modern MT5Service (NO SlaveService/ClassicService)
python3 << 'PYTHON_EOF'
from pathlib import Path
code = '''#!/usr/bin/env python
"""Modern RPyC server with MT5Service (NO STUBS).

Generated by s6 service for execution inside Wine.
Features:
- Modern rpyc.Service (NOT deprecated SlaveService/ClassicService)
- ThreadPoolServer for concurrent handling
- Signal handling (SIGTERM/SIGINT) for clean container stops
- Python 3.13+ type hints
- NO STUBS - fails if MT5 unavailable
"""
from __future__ import annotations

import argparse
import signal
import sys
import threading
from types import FrameType
from typing import Any

import rpyc
from rpyc.utils.server import ThreadPoolServer

# Global server reference for signal handler
_server: ThreadPoolServer | None = None


class MT5Service(rpyc.Service):
    """Modern RPyC service for MT5. NO STUBS."""

    _mt5_module: Any = None
    _mt5_lock = threading.RLock()

    def on_connect(self, conn: rpyc.Connection) -> None:
        with MT5Service._mt5_lock:
            if MT5Service._mt5_module is None:
                import MetaTrader5 as MT5
                MT5Service._mt5_module = MT5
                print("[mt5server] MT5 module loaded")

    def on_disconnect(self, conn: rpyc.Connection) -> None:
        pass

    def exposed_get_mt5(self) -> Any:
        return MT5Service._mt5_module

    def exposed_health_check(self) -> dict[str, Any]:
        return {"healthy": True, "mt5_available": MT5Service._mt5_module is not None}

    def exposed_initialize(
        self,
        path: str | None = None,
        login: int | None = None,
        password: str | None = None,
        server: str | None = None,
        timeout: int | None = None,
        portable: bool = False,
    ) -> bool:
        # Build kwargs, only including non-None values
        # MT5 doesn't accept None for login/password/server
        kwargs: dict[str, Any] = {}
        if path is not None:
            kwargs["path"] = path
        if login is not None:
            kwargs["login"] = login
        if password is not None:
            kwargs["password"] = password
        if server is not None:
            kwargs["server"] = server
        if timeout is not None:
            kwargs["timeout"] = timeout
        if portable:
            kwargs["portable"] = portable
        return MT5Service._mt5_module.initialize(**kwargs)

    def exposed_login(
        self, login: int, password: str, server: str, timeout: int = 60000
    ) -> bool:
        return MT5Service._mt5_module.login(
            login=login, password=password, server=server, timeout=timeout
        )

    def exposed_shutdown(self) -> None:
        return MT5Service._mt5_module.shutdown()

    def exposed_version(self) -> tuple[int, int, str] | None:
        return MT5Service._mt5_module.version()

    def exposed_last_error(self) -> tuple[int, str]:
        return MT5Service._mt5_module.last_error()

    def exposed_terminal_info(self) -> Any:
        return MT5Service._mt5_module.terminal_info()

    def exposed_account_info(self) -> Any:
        return MT5Service._mt5_module.account_info()

    def exposed_symbols_total(self) -> int:
        return MT5Service._mt5_module.symbols_total()

    def exposed_symbols_get(self, group: str | None = None) -> Any:
        if group:
            return MT5Service._mt5_module.symbols_get(group=group)
        return MT5Service._mt5_module.symbols_get()

    def exposed_symbol_info(self, symbol: str) -> Any:
        return MT5Service._mt5_module.symbol_info(symbol)

    def exposed_symbol_info_tick(self, symbol: str) -> Any:
        return MT5Service._mt5_module.symbol_info_tick(symbol)

    def exposed_symbol_select(self, symbol: str, enable: bool = True) -> bool:
        return MT5Service._mt5_module.symbol_select(symbol, enable)

    def exposed_copy_rates_from(
        self, symbol: str, timeframe: int, date_from: Any, count: int
    ) -> Any:
        return MT5Service._mt5_module.copy_rates_from(
            symbol, timeframe, date_from, count
        )

    def exposed_copy_rates_from_pos(
        self, symbol: str, timeframe: int, start_pos: int, count: int
    ) -> Any:
        return MT5Service._mt5_module.copy_rates_from_pos(
            symbol, timeframe, start_pos, count
        )

    def exposed_copy_rates_range(
        self, symbol: str, timeframe: int, date_from: Any, date_to: Any
    ) -> Any:
        return MT5Service._mt5_module.copy_rates_range(
            symbol, timeframe, date_from, date_to
        )

    def exposed_copy_ticks_from(
        self, symbol: str, date_from: Any, count: int, flags: int
    ) -> Any:
        return MT5Service._mt5_module.copy_ticks_from(
            symbol, date_from, count, flags
        )

    def exposed_copy_ticks_range(
        self, symbol: str, date_from: Any, date_to: Any, flags: int
    ) -> Any:
        return MT5Service._mt5_module.copy_ticks_range(
            symbol, date_from, date_to, flags
        )

    def exposed_order_calc_margin(
        self, action: int, symbol: str, volume: float, price: float
    ) -> float | None:
        return MT5Service._mt5_module.order_calc_margin(
            action, symbol, volume, price
        )

    def exposed_order_calc_profit(
        self,
        action: int,
        symbol: str,
        volume: float,
        price_open: float,
        price_close: float,
    ) -> float | None:
        return MT5Service._mt5_module.order_calc_profit(
            action, symbol, volume, price_open, price_close
        )

    def exposed_order_check(self, request: dict[str, Any]) -> Any:
        return MT5Service._mt5_module.order_check(request)

    def exposed_order_send(self, request: dict[str, Any]) -> Any:
        return MT5Service._mt5_module.order_send(request)

    def exposed_positions_total(self) -> int:
        return MT5Service._mt5_module.positions_total()

    def exposed_positions_get(
        self,
        symbol: str | None = None,
        group: str | None = None,
        ticket: int | None = None,
    ) -> Any:
        kwargs: dict[str, Any] = {}
        if symbol:
            kwargs["symbol"] = symbol
        if group:
            kwargs["group"] = group
        if ticket:
            kwargs["ticket"] = ticket
        if kwargs:
            return MT5Service._mt5_module.positions_get(**kwargs)
        return MT5Service._mt5_module.positions_get()

    def exposed_orders_total(self) -> int:
        return MT5Service._mt5_module.orders_total()

    def exposed_orders_get(
        self,
        symbol: str | None = None,
        group: str | None = None,
        ticket: int | None = None,
    ) -> Any:
        kwargs: dict[str, Any] = {}
        if symbol:
            kwargs["symbol"] = symbol
        if group:
            kwargs["group"] = group
        if ticket:
            kwargs["ticket"] = ticket
        if kwargs:
            return MT5Service._mt5_module.orders_get(**kwargs)
        return MT5Service._mt5_module.orders_get()

    def exposed_history_orders_total(self, date_from: Any, date_to: Any) -> int | None:
        return MT5Service._mt5_module.history_orders_total(date_from, date_to)

    def exposed_history_orders_get(
        self,
        date_from: Any = None,
        date_to: Any = None,
        group: str | None = None,
        ticket: int | None = None,
        position: int | None = None,
    ) -> Any:
        kwargs: dict[str, Any] = {}
        if date_from:
            kwargs["date_from"] = date_from
        if date_to:
            kwargs["date_to"] = date_to
        if group:
            kwargs["group"] = group
        if ticket:
            kwargs["ticket"] = ticket
        if position:
            kwargs["position"] = position
        if kwargs:
            return MT5Service._mt5_module.history_orders_get(**kwargs)
        return MT5Service._mt5_module.history_orders_get()

    def exposed_history_deals_total(self, date_from: Any, date_to: Any) -> int | None:
        return MT5Service._mt5_module.history_deals_total(date_from, date_to)

    def exposed_history_deals_get(
        self,
        date_from: Any = None,
        date_to: Any = None,
        group: str | None = None,
        ticket: int | None = None,
        position: int | None = None,
    ) -> Any:
        kwargs: dict[str, Any] = {}
        if date_from:
            kwargs["date_from"] = date_from
        if date_to:
            kwargs["date_to"] = date_to
        if group:
            kwargs["group"] = group
        if ticket:
            kwargs["ticket"] = ticket
        if position:
            kwargs["position"] = position
        if kwargs:
            return MT5Service._mt5_module.history_deals_get(**kwargs)
        return MT5Service._mt5_module.history_deals_get()


def graceful_shutdown(signum: int, frame: FrameType | None) -> None:
    """Handle shutdown signals for clean container stops."""
    sig_name = signal.Signals(signum).name
    print(f"[mt5server] Received {sig_name}, shutting down gracefully...")
    if _server is not None:
        _server.close()
    sys.exit(0)


def main() -> int:
    """Run the RPyC server."""
    global _server

    parser = argparse.ArgumentParser(description="Modern RPyC Server for MT5")
    parser.add_argument("--host", default="0.0.0.0", help="Host to bind")
    parser.add_argument("-p", "--port", type=int, default=8001, help="Port")
    args = parser.parse_args()

    # Setup signal handlers for graceful shutdown
    signal.signal(signal.SIGTERM, graceful_shutdown)
    signal.signal(signal.SIGINT, graceful_shutdown)

    print(f"[mt5server] Starting MT5Service on {args.host}:{args.port}")
    print(f"[mt5server] Python {sys.version}")
    print("[mt5server] Using modern rpyc.Service (NO SlaveService/ClassicService)")

    _server = ThreadPoolServer(
        MT5Service,
        hostname=args.host,
        port=args.port,
        reuse_addr=True,
        nbThreads=10,
        protocol_config={"allow_public_attrs": True, "sync_request_timeout": 300},
    )

    try:
        _server.start()
    except KeyboardInterrupt:
        print("[mt5server] Server interrupted")
    except Exception as e:
        print(f"[mt5server] Server error: {e}")
        return 1
    finally:
        if _server is not None:
            _server.close()
        print("[mt5server] Server stopped")

    return 0


if __name__ == "__main__":
    sys.exit(main())
'''
Path('/tmp/mt5linux/server.py').write_text(code)
PYTHON_EOF

echo "[svc-mt5server] Starting Wine RPyC server on port ${mt5server_port}"
echo "[svc-mt5server] Using modern MT5Service"

# Convert Linux path to Windows path for the server script
WINE_SERVER_PATH="Z:\\tmp\\mt5linux\\server.py"

# Run as user abc (same as KasmVNC) with exec to replace shell
exec s6-setuidgid abc \
    ${wine_executable} "$WINE_PYTHON_PATH" "$WINE_SERVER_PATH" \
    --host 0.0.0.0 -p ${mt5server_port}
