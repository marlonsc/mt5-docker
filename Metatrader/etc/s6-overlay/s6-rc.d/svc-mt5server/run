#!/usr/bin/with-contenv bash
# s6 service: Wine RPyC server for MT5
#
# This service runs the RPyC server inside Wine, supervised by s6-overlay.
# If the process crashes, s6 will automatically restart it.

# Load environment from 00_env.sh (fail-fast if missing or broken)
ENV_FILE="/Metatrader/scripts/00_env.sh"
if [ ! -f "$ENV_FILE" ]; then
    echo "[svc-mt5server] ERROR: Environment file not found: $ENV_FILE"
    exit 1
fi
if ! source "$ENV_FILE"; then
    echo "[svc-mt5server] ERROR: Failed to load environment from $ENV_FILE"
    exit 1
fi

# Verify required variables are set
if [ -z "${wine_executable:-}" ]; then
    echo "[svc-mt5server] ERROR: wine_executable not defined"
    exit 1
fi
if [ -z "${mt5server_port:-}" ]; then
    echo "[svc-mt5server] ERROR: mt5server_port not defined"
    exit 1
fi

# Ensure server directory exists
mkdir -p /tmp/mt5linux

# Generate the RPyC server script with signal handling for graceful shutdown
python3 << 'PYTHON_EOF'
from pathlib import Path
code = '''#!/usr/bin/env python
"""RPyC server with graceful shutdown support.

Generated by s6 service for execution inside Wine.
Features:
- Signal handling (SIGTERM/SIGINT) for clean container stops
- Clean shutdown of ThreadedServer
- Structured log output
"""
import argparse
import signal
import sys
from rpyc.utils.server import ThreadedServer
from rpyc.core import SlaveService

# Global server reference for signal handler
_server = None

def graceful_shutdown(signum, frame):
    """Handle shutdown signals for clean container stops."""
    sig_name = "SIGTERM" if signum == signal.SIGTERM else "SIGINT"
    print(f"[mt5linux] Received {sig_name}, shutting down gracefully...")
    if _server is not None:
        _server.close()
    sys.exit(0)

def main():
    global _server

    parser = argparse.ArgumentParser(description="RPyC Server for MT5")
    parser.add_argument("--host", default="0.0.0.0", help="Host to bind")
    parser.add_argument("-p", "--port", type=int, default=8001, help="Port")
    args = parser.parse_args()

    # Setup signal handlers for graceful shutdown
    signal.signal(signal.SIGTERM, graceful_shutdown)
    signal.signal(signal.SIGINT, graceful_shutdown)

    print(f"[mt5linux] Starting RPyC server on {args.host}:{args.port}")
    print("[mt5linux] Signal handlers registered for graceful shutdown")

    _server = ThreadedServer(
        SlaveService,
        hostname=args.host,
        port=args.port,
        reuse_addr=True,
    )

    try:
        _server.start()
    except KeyboardInterrupt:
        print("[mt5linux] Server interrupted")
    finally:
        if _server is not None:
            _server.close()
        print("[mt5linux] Server stopped")

if __name__ == "__main__":
    main()
'''
Path('/tmp/mt5linux/server.py').write_text(code)
PYTHON_EOF

echo "[svc-mt5server] Starting Wine RPyC server on port ${mt5server_port}"

# Run as user abc (same as KasmVNC) with exec to replace shell
exec s6-setuidgid abc \
    ${wine_executable} python.exe /tmp/mt5linux/server.py \
    --host 0.0.0.0 -p ${mt5server_port}
