# docker-compose.yaml - Isolated test configuration for mt5docker
#
# Location: tests/fixtures/docker-compose.yaml
#
# This overlay provides an ISOLATED test container for mt5docker development.
# Uses separate ports and container name to avoid conflicts with:
# - Production container (mt5, port 8001)
# - neptor tests (neptor-mt5-test, port 18812)
# - mt5linux tests (mt5linux-test, port 28812)
#
# mt5linux is installed from GitHub (github.com/marlonsc/mt5linux) via 50_python_linux.sh
#
# Usage (from project root):
#   docker compose -f docker-compose.yaml -f tests/fixtures/docker-compose.yaml up -d
#   # Or use the test script:
#   ./scripts/test-container.sh
#
# Verify:
#   docker ps  # Should show: mt5docker-test
#   nc -zv localhost 48812  # RPyC service

services:
  mt5:
    container_name: ${MT5_CONTAINER_NAME:-mt5docker-test}
    # Stricter resource limits for testing
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G
    # Logging configuration for tests
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"
    # File descriptor limits
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
      nproc:
        soft: 4096
        hard: 4096
    ports:
      - "${MT5_VNC_PORT:-43000}:3000"     # VNC (isolated from prod:3000, neptor:13000, mt5linux:23000)
      - "${MT5_RPYC_PORT:-48812}:8001"    # RPyC (isolated from prod:8001, neptor:18812, mt5linux:28812)
      - "${MT5_HEALTH_PORT:-48002}:8002"  # Health (isolated from prod:8002, neptor:18002, mt5linux:28002)
    volumes:
      - config_data_mt5docker_test:/config:uid=911,gid=911
      - downloads_mt5docker_test:/downloads:uid=911,gid=911
      - mt5_cache:/cache:uid=911,gid=911
      - ../../data:/data:ro
    environment:
      # MT5 test credentials - OPTIONAL: configure in .env file for full tests
      # Without credentials, container starts but MT5 login tests are skipped
      - MT5_LOGIN=${MT5_LOGIN:-}
      - MT5_PASSWORD=${MT5_PASSWORD:-}
      - MT5_SERVER=${MT5_SERVER:-MetaQuotes-Demo}

volumes:
  config_data_mt5docker_test:
    driver: local
    labels:
      description: "MT5Docker test configuration"
  downloads_mt5docker_test:
    driver: local
    labels:
      description: "MT5Docker test downloads"
